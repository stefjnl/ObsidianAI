@using ObsidianAI.Web.Models
@using System
@using System.Linq

<div class="message @(Message.Sender == MessageSender.User ? "user" : "")">
    <div class="message-avatar" aria-hidden="true">
        @(Message.Sender == MessageSender.User ? "ðŸ‘¤" : "ðŸ¤–")
    </div>
    <div class="message-content">
        @if (Message.Sender == MessageSender.AI)
        {
            <MarkdownContent Content="@Message.Content" />
        }
        else
        {
            @Message.Content
        }

        @if (ShouldShowMicrosoftLearnBadge(Message))
        {
            <span class="tool-badge microsoft-learn" title="Microsoft Learn tools powered this response">ðŸ“š Microsoft Learn</span>
        }
        
        @if (Message.IsProcessing)
        {
            <div class="status-indicator">
                <div class="spinner"></div>
                @GetProcessingText(Message.ProcessingType)
            </div>
        }
        
        @if (Message.ActionCard != null)
        {
            <ActionCard Card="Message.ActionCard" OnConfirmed="OnActionConfirmed" OnCancelled="OnActionCancelled" OnEdit="OnActionEdit" />
        }
        
        @if (Message.SearchResults.Any())
        {
            @foreach (var result in Message.SearchResults)
            {
                <SearchResult Result="result" />
            }
        }
        
        @if (Message.FileOperation != null)
        {
            <FileOperationResult Result="Message.FileOperation" />
        }
    </div>
</div>

@code {
    [Parameter]
    public ChatMessage Message { get; set; } = default!;
    
    [Parameter]
    public EventCallback<string> OnActionConfirmed { get; set; }
    
    [Parameter]
    public EventCallback<string> OnActionCancelled { get; set; }
    
    [Parameter]
    public EventCallback<string> OnActionEdit { get; set; }
    
    private string GetProcessingText(ProcessingType processingType)
    {
        return processingType switch
        {
            ProcessingType.Searching => "ðŸ” Searching...",
            ProcessingType.Writing => "âœï¸ Writing...",
            ProcessingType.Reorganizing => "ðŸ”„ Reorganizing...",
            ProcessingType.Thinking => "ðŸ¤” Thinking...",
            _ => "Processing..."
        };
    }

    private static bool ShouldShowMicrosoftLearnBadge(ChatMessage message) =>
        message.Sender == MessageSender.AI && message.ToolsUsed.Any(IsMicrosoftLearnTool);

    private static bool IsMicrosoftLearnTool(string toolName) =>
        !string.IsNullOrWhiteSpace(toolName) && toolName.StartsWith("microsoft_", StringComparison.OrdinalIgnoreCase);
}