@using ObsidianAI.Web.Models

<div class="vault-tree-node" style="padding-left: @(Level * 16)px">
    <div class="vault-item @(Item.Type == VaultItemType.Folder ? "vault-folder" : "vault-file")"
         @onclick="HandleClick">
        
        @if (Item.Type == VaultItemType.Folder)
        {
            <span class="vault-expand-icon">@(Item.IsExpanded ? "â–¼" : "â–¶")</span>
        }
        else
        {
            <span class="vault-expand-icon"></span>
        }
        
        <span class="vault-icon">@GetIcon()</span>
        <span class="vault-name" title="@Item.Path">@Item.Name</span>
        
        @if (Item.Type == VaultItemType.File && Item.Size.HasValue)
        {
            <span class="vault-size">@FormatSize(Item.Size.Value)</span>
        }
    </div>
    
    @if (Item.IsExpanded && Item.Children.Count > 0)
    {
        <div class="vault-children">
            @foreach (var child in Item.Children)
            {
                <VaultTreeNode Item="child"
                               Level="Level + 1"
                               OnItemClick="OnItemClick"
                               OnFolderExpand="OnFolderExpand" />
            }
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public VaultItemData Item { get; set; } = default!;
    
    [Parameter]
    public int Level { get; set; }
    
    [Parameter]
    public EventCallback<VaultItemData> OnItemClick { get; set; }
    
    [Parameter]
    public EventCallback<VaultItemData> OnFolderExpand { get; set; }
    
    private string GetIcon()
    {
        if (Item.Type == VaultItemType.Folder)
        {
            return Item.IsExpanded ? "ðŸ“‚" : "ðŸ“";
        }
        
        return Item.Extension?.ToLowerInvariant() switch
        {
            ".md" => "ðŸ“",
            ".pdf" => "ðŸ“•",
            ".png" or ".jpg" or ".jpeg" or ".gif" or ".webp" => "ðŸ–¼ï¸",
            ".mp4" or ".mov" or ".avi" => "ðŸŽ¬",
            ".mp3" or ".wav" or ".flac" => "ðŸŽµ",
            ".zip" or ".rar" or ".7z" => "ðŸ“¦",
            ".txt" => "ðŸ“„",
            ".json" or ".xml" or ".yaml" or ".yml" => "âš™ï¸",
            ".js" or ".ts" or ".py" or ".cs" or ".java" => "ðŸ’»",
            _ => "ðŸ“„"
        };
    }
    
    private async Task HandleClick()
    {
        if (Item.Type == VaultItemType.Folder)
        {
            await OnFolderExpand.InvokeAsync(Item);
        }
        else
        {
            await OnItemClick.InvokeAsync(Item);
        }
    }
    
    private string FormatSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes}B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024}KB";
        return $"{bytes / (1024 * 1024)}MB";
    }
}
